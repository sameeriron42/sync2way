# Two-Way-Integration

The objective of this exercise is to simulate a product that you are building that has a simple
customer catalog (think of it as a simple customer table) and build a two-way integration with a
customer catalog in an external service - Stripe in this case.

## Process Flow
![](process-flow.png)

## Tech Stack

python | rabbitmq | fastapi | mysql
:-------------------------:|:-------------------------: | :---: | :---:
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Python-logo-notext.svg/1200px-Python-logo-notext.svg.png" width=250 height=200> | <img src="https://pbs.twimg.com/profile_images/1223261138059780097/eH73w5lN_400x400.jpg" width=250 height=200> | <img src="https://pbs.twimg.com/profile_images/1417542931209199621/fWMEIB5j_400x400.jpg" width=250 height=200> | <img src="https://cdn-icons-png.flaticon.com/512/5968/5968313.png" width=250 height=200>


## Environment Variables

To run this project, you will need to add the following environment variables to your .env file

`SQL_ENGINE_URI`: of the form `<dbms_type> + <dbms_driver>://<username>:<password>@<IP>:<PORT>/<database_name>`

`STRIPE_RESTRICTED_KEY`: use API key or generate restricted key from stripe dashboard

`WEBHOOK_SECRET`: see setup stripe webhook section below
## Run Locally

Clone the project

```bash
  git clone https://github.com/sameeriron42/two-way-integration.git
```

Go to the project directory

```bash
  cd two-way-integration
```

Install dependencies

```bash
  pip install -r requirements.txt
```

set PYTHONPATH environment variable for modules imports
 
```
  export PYTHONPATH="${PYTHONPATH}:/path/to/your/project/"
```

- start mysql daemon
- start RabbitMQ service
- cd `app/`

Start the Product, in this case CRUD API
```bash
  uvicorn app:app --reload
```
Start stripe worker (on seperate terminal instance)
```bash
  cd app/queues/
  py -m stripe_worker.py
```
Start Webhook handler (seperate terminal instance)

```bash
  cd app/webhook
  uvicorn main:app --port 5005 --reload
```
Expose the webhook server using ngrok
```bash
    ngrok http 5005
```
### Setup Stripe webhook
- Navigate to stripe dashboard on test account
- on developers->Webhook section add new webhook
- under customer events, select 
- `customer.created`
- `customer.update`
- `customr.deleted`
- use the tunnel link generated by ngrok, paste it in webhook section of stripe 
- Name it as customer-hook, click create webhook. copy the WEBHOOK SECRET generated.
